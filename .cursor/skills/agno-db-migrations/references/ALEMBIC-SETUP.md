# Alembic Setup Templates

Complete templates for setting up Alembic in an Agno project. These are adapted for projects that use `db.url.db_url` for database configuration.

## `db/tables/base.py`

```python
from sqlalchemy.orm import DeclarativeBase


class Base(DeclarativeBase):
    pass
```

## `db/tables/__init__.py`

```python
from db.tables.base import Base

# Import all table classes below so Alembic autogenerate can detect them.
# Example:
# from db.tables.user import UsersTable
```

## `alembic.ini`

Place this file in the backend root directory. Key settings to configure:

```ini
[alembic]
script_location = db/migrations
prepend_sys_path = .
version_path_separator = os

# The sqlalchemy.url is set programmatically in env.py,
# so this line can be left empty or removed.
# sqlalchemy.url =

[post_write_hooks]
hooks = black
black.type = console_scripts
black.entrypoint = black
black.options = -l 120 REVISION_SCRIPT_FILENAME

[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARN
handlers = console
qualname =

[logger_sqlalchemy]
level = WARN
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S
```

## `db/migrations/env.py`

This replaces the auto-generated `env.py` after running `alembic init db/migrations`.

```python
from logging.config import fileConfig

from alembic import context
from sqlalchemy import engine_from_config, pool

from db.tables import Base
from db.url import db_url

# Alembic Config object
config = context.config

# Set the SQLAlchemy URL programmatically from the project's db_url
config.set_main_option("sqlalchemy.url", db_url)

# Interpret the config file for Python logging
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# SQLAlchemy MetaData for autogenerate support
target_metadata = Base.metadata


def include_name(name, type_, parent_names):
    """Only include tables that are defined in our Base metadata."""
    if type_ == "table":
        return name in target_metadata.tables
    else:
        return True


def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode.

    Configures the context with just a URL and not an Engine.
    Calls to context.execute() emit the given string to the script output.
    """
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
        include_name=include_name,
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online() -> None:
    """Run migrations in 'online' mode.

    Creates an Engine and associates a connection with the context.
    """
    connectable = engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=target_metadata,
            include_name=include_name,
        )

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
```

## `db/migrations/script.py.mako`

This file is auto-generated by `alembic init` but listed here for reference. It controls the template for new migration files:

```mako
"""${message}

Revision ID: ${up_revision}
Revises: ${down_revision | comma,n}
Create Date: ${create_date}

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
${imports if imports else ""}

# revision identifiers, used by Alembic.
revision: str = ${repr(up_revision)}
down_revision: Union[str, None] = ${repr(down_revision)}
branch_labels: Union[str, Sequence[str], None] = ${repr(branch_labels)}
depends_on: Union[str, Sequence[str], None] = ${repr(depends_on)}


def upgrade() -> None:
    ${upgrades if upgrades else "pass"}


def downgrade() -> None:
    ${downgrades if downgrades else "pass"}
```

## Full Setup Checklist

1. [ ] `alembic` added to dependencies and container rebuilt
2. [ ] `db/tables/base.py` created with `Base` class
3. [ ] `db/tables/__init__.py` created, importing `Base`
4. [ ] `alembic init db/migrations` run inside the container
5. [ ] `alembic.ini` configured with `script_location = db/migrations`
6. [ ] `db/migrations/env.py` replaced with the template above
7. [ ] First table class created in `db/tables/` and imported in `__init__.py`
8. [ ] First revision created: `alembic -c db/alembic.ini revision --autogenerate -m "Initialize DB"`
9. [ ] Migration applied: `alembic -c db/alembic.ini upgrade head`
